<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>DealHunter ‚Äî USA Deals</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0f;
  --surface: #13131a;
  --card: #1a1a24;
  --border: #2a2a38;
  --accent: #ff4d00;
  --accent2: #ff9500;
  --gold: #ffd700;
  --text: #f0f0f5;
  --muted: #6b6b80;
  --prime: #00b4d8;
  --error: #ff2d55;
  --green: #00d68f;
  --r: 14px;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(10,10,15,0.92);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  padding: 12px 16px;
}
.header-top {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 10px;
}
.logo {
  font-family: 'Syne', sans-serif;
  font-weight: 800; font-size: 20px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  letter-spacing: -0.5px;
}
.header-badge {
  font-size: 11px; color: var(--muted);
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 3px 8px; border-radius: 20px;
}

/* ‚îÄ‚îÄ Search ‚îÄ‚îÄ */
.search-wrap { position: relative; }
.search-input {
  width: 100%;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 38px 10px 14px;
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
  outline: none;
  transition: border-color .2s;
}
.search-input::placeholder { color: var(--muted); }
.search-input:focus { border-color: var(--accent); }
.search-icon {
  position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
  color: var(--muted); font-size: 16px; cursor: pointer;
  transition: color .2s;
}
.search-icon:hover { color: var(--accent); }

/* ‚îÄ‚îÄ Pages ‚îÄ‚îÄ */
.page { display: none; padding: 16px; }
.page.active { display: block; }

/* ‚îÄ‚îÄ Section Title ‚îÄ‚îÄ */
.section-title {
  font-family: 'Syne', sans-serif;
  font-size: 18px; font-weight: 700;
  margin-bottom: 14px;
  display: flex; align-items: center; gap: 8px;
}
.section-title span { color: var(--muted); font-size: 13px; font-weight: 400; font-family: 'DM Sans', sans-serif; }

/* ‚îÄ‚îÄ Category Grid ‚îÄ‚îÄ */
.cat-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 28px;
}
.cat-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 16px 10px;
  text-align: center;
  cursor: pointer;
  transition: all .2s;
  position: relative; overflow: hidden;
}
.cat-card::before {
  content: '';
  position: absolute; inset: 0;
  background: linear-gradient(135deg, transparent 60%, var(--cat-color, var(--accent)) 200%);
  opacity: 0; transition: opacity .3s;
}
.cat-card:hover::before, .cat-card.active::before { opacity: 1; }
.cat-card.active {
  border-color: var(--cat-color, var(--accent));
  box-shadow: 0 0 0 1px var(--cat-color, var(--accent));
}
.cat-icon { font-size: 28px; margin-bottom: 6px; display: block; }
.cat-name {
  font-size: 11px; font-weight: 500;
  color: var(--muted);
  line-height: 1.2;
}
.cat-card.active .cat-name { color: var(--text); }
.cat-count {
  position: absolute; top: 6px; right: 6px;
  font-size: 10px; font-weight: 700;
  background: var(--accent); color: white;
  border-radius: 10px; padding: 1px 5px;
  min-width: 18px; text-align: center;
}

/* ‚îÄ‚îÄ Hot Deals Banner ‚îÄ‚îÄ */
.hot-banner {
  background: linear-gradient(135deg, #1a0800, #2d1000);
  border: 1px solid #4a2000;
  border-radius: var(--r);
  padding: 14px 16px;
  margin-bottom: 20px;
  display: flex; align-items: center; gap: 12px;
  cursor: pointer;
  transition: transform .2s;
}
.hot-banner:active { transform: scale(0.98); }
.hot-banner-icon { font-size: 32px; }
.hot-banner-text h3 {
  font-family: 'Syne', sans-serif;
  font-size: 15px; font-weight: 700;
  color: var(--accent2);
}
.hot-banner-text p { font-size: 12px; color: var(--muted); margin-top: 2px; }
.hot-banner-arrow { margin-left: auto; color: var(--accent2); font-size: 20px; }

/* ‚îÄ‚îÄ Deal Cards ‚îÄ‚îÄ */
.deals-grid { display: flex; flex-direction: column; gap: 10px; }

.deal-card {
  display: flex; gap: 12px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 12px;
  text-decoration: none; color: inherit;
  transition: all .2s;
  position: relative; overflow: hidden;
  animation: fadeUp .3s ease both;
}
.deal-card:active { transform: scale(0.98); border-color: var(--accent); }

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(12px); }
  to   { opacity: 1; transform: translateY(0); }
}

.deal-img-wrap {
  flex-shrink: 0;
  width: 80px; height: 80px;
  border-radius: 10px;
  overflow: hidden;
  background: var(--surface);
  display: flex; align-items: center; justify-content: center;
}
.deal-img {
  width: 100%; height: 100%;
  object-fit: cover;
}
.deal-img-placeholder { font-size: 32px; }

.deal-body { flex: 1; min-width: 0; }
.deal-badges { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 5px; }
.badge {
  font-size: 10px; font-weight: 700;
  padding: 2px 7px; border-radius: 20px;
}
.badge-error { background: var(--error); color: white; }
.badge-prime { background: rgba(0,180,216,0.15); color: var(--prime); border: 1px solid var(--prime); }
.badge-cat   { background: var(--surface); color: var(--muted); border: 1px solid var(--border); }

.deal-title {
  font-size: 13px; font-weight: 500; line-height: 1.4;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
  overflow: hidden; margin-bottom: 7px;
}
.deal-price-row { display: flex; align-items: center; gap: 7px; flex-wrap: wrap; }
.deal-price {
  font-family: 'Syne', sans-serif;
  font-size: 17px; font-weight: 700; color: var(--green);
}
.deal-original {
  font-size: 12px; color: var(--muted);
  text-decoration: line-through;
}
.deal-discount {
  font-size: 11px; font-weight: 700;
  background: rgba(255,77,0,0.15);
  color: var(--accent); border: 1px solid rgba(255,77,0,0.3);
  padding: 1px 6px; border-radius: 20px;
}
.deal-meta {
  font-size: 11px; color: var(--muted);
  margin-top: 5px; display: flex; align-items: center; gap: 6px;
}
.ai-chip {
  font-size: 10px;
  background: rgba(255,149,0,0.1);
  color: var(--accent2); border: 1px solid rgba(255,149,0,0.25);
  padding: 1px 5px; border-radius: 10px;
}

/* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
.skeleton { animation: shimmer 1.5s infinite; }
@keyframes shimmer {
  0%   { opacity: .4; }
  50%  { opacity: .8; }
  100% { opacity: .4; }
}
.skel-card {
  height: 100px;
  background: var(--card);
  border-radius: var(--r);
  margin-bottom: 10px;
}

/* ‚îÄ‚îÄ Empty State ‚îÄ‚îÄ */
.empty {
  text-align: center; padding: 48px 20px;
  color: var(--muted);
}
.empty-icon { font-size: 48px; margin-bottom: 12px; }
.empty h3 { font-family: 'Syne', sans-serif; color: var(--text); margin-bottom: 6px; }

/* ‚îÄ‚îÄ Back Button ‚îÄ‚îÄ */
.back-btn {
  display: flex; align-items: center; gap: 6px;
  background: none; border: none;
  color: var(--muted); font-size: 14px;
  cursor: pointer; padding: 0; margin-bottom: 16px;
  font-family: 'DM Sans', sans-serif;
  transition: color .2s;
}
.back-btn:hover { color: var(--text); }

/* ‚îÄ‚îÄ Bottom Nav ‚îÄ‚îÄ */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: rgba(10,10,15,0.95);
  backdrop-filter: blur(20px);
  border-top: 1px solid var(--border);
  display: flex;
  padding: 8px 0 max(8px, env(safe-area-inset-bottom));
}
.nav-btn {
  flex: 1; display: flex; flex-direction: column; align-items: center;
  gap: 3px; background: none; border: none; cursor: pointer;
  color: var(--muted); font-size: 10px;
  font-family: 'DM Sans', sans-serif;
  transition: color .2s; padding: 4px 0;
}
.nav-btn .nav-icon { font-size: 20px; }
.nav-btn.active { color: var(--accent); }

/* ‚îÄ‚îÄ Stats Bar ‚îÄ‚îÄ */
.stats-bar {
  display: flex; gap: 8px; margin-bottom: 20px;
}
.stat-chip {
  flex: 1; background: var(--card);
  border: 1px solid var(--border); border-radius: 10px;
  padding: 10px 8px; text-align: center;
}
.stat-val {
  font-family: 'Syne', sans-serif;
  font-size: 18px; font-weight: 700;
  color: var(--accent2);
}
.stat-label { font-size: 10px; color: var(--muted); margin-top: 2px; }

/* ‚îÄ‚îÄ Price Error Banner ‚îÄ‚îÄ */
.error-banner {
  background: linear-gradient(135deg, #1a0008, #2d000f);
  border: 1px solid var(--error);
  border-radius: var(--r);
  padding: 10px 14px;
  margin-bottom: 14px;
  display: flex; align-items: center; gap: 8px;
  font-size: 12px;
}
.error-banner strong { color: var(--error); font-family: 'Syne', sans-serif; }

body { padding-bottom: 70px; }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-top">
    <div class="logo">üõç DealHunter</div>
    <div class="header-badge" id="dealCount">Loading...</div>
  </div>
  <div class="search-wrap">
    <input class="search-input" id="searchInput" placeholder="Search any product..." type="text">
    <span class="search-icon" onclick="doSearch()">üîç</span>
  </div>
</div>

<!-- HOME PAGE -->
<div class="page active" id="homePage">
  <!-- Stats -->
  <div class="stats-bar">
    <div class="stat-chip">
      <div class="stat-val" id="statDeals">‚Äî</div>
      <div class="stat-label">Today's Deals</div>
    </div>
    <div class="stat-chip">
      <div class="stat-val" id="statMax">‚Äî</div>
      <div class="stat-label">Max Discount</div>
    </div>
    <div class="stat-chip">
      <div class="stat-val" id="statCats">‚Äî</div>
      <div class="stat-label">Categories</div>
    </div>
  </div>

  <!-- Hot Deals Banner -->
  <div class="hot-banner" onclick="loadAllDeals()">
    <div class="hot-banner-icon">üî•</div>
    <div class="hot-banner-text">
      <h3>Today's Hot Deals</h3>
      <p>Fresh from our deals channel</p>
    </div>
    <div class="hot-banner-arrow">‚Ä∫</div>
  </div>

  <!-- Categories -->
  <div class="section-title">
    Browse by Category
    <span id="catSubtitle"></span>
  </div>
  <div class="cat-grid" id="catGrid">
    <!-- Filled dynamically -->
  </div>
</div>

<!-- DEALS PAGE -->
<div class="page" id="dealsPage">
  <button class="back-btn" onclick="goHome()">‚Äπ Back</button>
  <div class="section-title" id="dealsTitle">Deals</div>
  <div id="errorBanners"></div>
  <div class="deals-grid" id="dealsGrid"></div>
</div>

<!-- SEARCH PAGE -->
<div class="page" id="searchPage">
  <button class="back-btn" onclick="goHome()">‚Äπ Back</button>
  <div class="section-title" id="searchTitle">Search Results</div>
  <div class="deals-grid" id="searchGrid"></div>
</div>

<!-- Bottom Nav -->
<div class="bottom-nav">
  <button class="nav-btn active" id="navHome" onclick="goHome()">
    <span class="nav-icon">üè†</span>Home
  </button>
  <button class="nav-btn" id="navDeals" onclick="loadAllDeals()">
    <span class="nav-icon">üî•</span>Hot Deals
  </button>
  <button class="nav-btn" id="navSearch" onclick="focusSearch()">
    <span class="nav-icon">üîç</span>Search
  </button>
</div>

<script>
const BACKEND = 'https://web-production-8d6c4.up.railway.app';
const tg = window.Telegram?.WebApp;
if (tg) { tg.ready(); tg.expand(); }

// Category config: hashtag ‚Üí emoji + color
const CAT_CONFIG = {
  'Electronics':        { icon: 'üíª', color: '#00b4d8' },
  'Clothing':           { icon: 'üëó', color: '#ff6b9d' },
  'ClothingShoesJewelry':{ icon: 'üë†', color: '#ff6b9d' },
  'HomeKitchen':        { icon: 'üè†', color: '#00d68f' },
  'Home':               { icon: 'üè†', color: '#00d68f' },
  'Kitchen':            { icon: 'üç≥', color: '#00d68f' },
  'Toys':               { icon: 'üß∏', color: '#ffd700' },
  'ToysGames':          { icon: 'üéÆ', color: '#ffd700' },
  'BabyProducts':       { icon: 'üë∂', color: '#ff9500' },
  'Beauty':             { icon: 'üíÑ', color: '#ff6b9d' },
  'BeautyPersonalCare': { icon: '‚ú®', color: '#ff6b9d' },
  'Sports':             { icon: '‚öΩ', color: '#00d68f' },
  'SportsOutdoors':     { icon: 'üèïÔ∏è', color: '#00d68f' },
  'Automotive':         { icon: 'üöó', color: '#6b6bff' },
  'Books':              { icon: 'üìö', color: '#ffd700' },
  'PetSupplies':        { icon: 'üêæ', color: '#ff9500' },
  'MusicalInstruments': { icon: 'üéµ', color: '#9b59b6' },
  'OfficeProducts':     { icon: 'üíº', color: '#6b6bff' },
  'Garden':             { icon: 'üåø', color: '#00d68f' },
  'Health':             { icon: 'üíä', color: '#00d68f' },
  'Tools':              { icon: 'üîß', color: '#95a5a6' },
};

function getCatConfig(tag) {
  if (!tag) return { icon: 'üè∑Ô∏è', color: '#ff4d00' };
  // Try exact match first
  for (const [k, v] of Object.entries(CAT_CONFIG)) {
    if (tag.toLowerCase().includes(k.toLowerCase()) || k.toLowerCase().includes(tag.toLowerCase())) {
      return v;
    }
  }
  return { icon: 'üè∑Ô∏è', color: '#ff4d00' };
}

let allDeals = [];
let categories = {};

async function init() {
  try {
    const res = await fetch(`${BACKEND}/hot-deals`);
    const data = await res.json();
    allDeals = data.deals || [];

    // Build categories from hashtags
    categories = {};
    allDeals.forEach(d => {
      const cat = d.category || 'Other';
      if (!categories[cat]) categories[cat] = [];
      categories[cat].push(d);
    });

    // Stats
    const maxDisc = Math.max(...allDeals.map(d => d.discount_percent || 0));
    document.getElementById('statDeals').textContent = allDeals.length;
    document.getElementById('statMax').textContent = maxDisc + '%';
    document.getElementById('statCats').textContent = Object.keys(categories).length;
    document.getElementById('dealCount').textContent = `${allDeals.length} deals today`;
    document.getElementById('catSubtitle').textContent = `${Object.keys(categories).length} categories`;

    renderCategoryGrid();
  } catch(e) {
    document.getElementById('dealCount').textContent = 'Error loading';
  }
}

function renderCategoryGrid() {
  const grid = document.getElementById('catGrid');
  const sorted = Object.entries(categories).sort((a, b) => b[1].length - a[1].length);

  // Add "All" card first
  const allCfg = { icon: 'üî•', color: '#ff4d00' };
  grid.innerHTML = `
    <div class="cat-card active" style="--cat-color:${allCfg.color}" onclick="loadAllDeals()" id="catAll">
      <span class="cat-icon">${allCfg.icon}</span>
      <div class="cat-name">All Deals</div>
      <div class="cat-count">${allDeals.length}</div>
    </div>
  ` + sorted.map(([cat, deals]) => {
    const cfg = getCatConfig(cat);
    return `
      <div class="cat-card" style="--cat-color:${cfg.color}" onclick="loadCategory('${cat}')">
        <span class="cat-icon">${cfg.icon}</span>
        <div class="cat-name">${cat.replace(/([A-Z])/g, ' $1').trim()}</div>
        <div class="cat-count">${deals.length}</div>
      </div>
    `;
  }).join('');
}

function loadCategory(cat) {
  const deals = categories[cat] || [];
  const cfg = getCatConfig(cat);
  showDealsPage(deals, `${cfg.icon} ${cat.replace(/([A-Z])/g, ' $1').trim()}`);
}

function loadAllDeals() {
  showDealsPage(allDeals, 'üî• Hot Deals');
}

function showDealsPage(deals, title) {
  showPage('dealsPage');
  setNav('navDeals');
  document.getElementById('dealsTitle').textContent = title;

  // Price error banner
  const errors = deals.filter(d => d.is_price_error);
  const banners = document.getElementById('errorBanners');
  banners.innerHTML = errors.length
    ? `<div class="error-banner">üî• <strong>${errors.length} PRICE ERROR${errors.length>1?'S':''}</strong> ‚Äî Grab them before they fix it!</div>`
    : '';

  renderDeals(deals, 'dealsGrid');
}

function renderDeals(deals, gridId) {
  const grid = document.getElementById(gridId);
  if (!deals.length) {
    grid.innerHTML = `<div class="empty"><div class="empty-icon">üòï</div><h3>No deals found</h3><p>Check back soon!</p></div>`;
    return;
  }
  grid.innerHTML = deals.map((deal, i) => {
    const cfg = getCatConfig(deal.category);
    const img = deal.image_url
      ? `<img class="deal-img" src="${deal.image_url}" alt="" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">`
      : '';
    return `
    <a class="deal-card" href="${deal.affiliate_url}" target="_blank" style="animation-delay:${i*0.05}s">
      <div class="deal-img-wrap">
        ${img}
        <div class="deal-img-placeholder" style="${deal.image_url ? 'display:none' : ''}">${cfg.icon}</div>
      </div>
      <div class="deal-body">
        <div class="deal-badges">
          ${deal.is_price_error ? '<span class="badge badge-error">üî• PRICE ERROR</span>' : ''}
          ${deal.is_prime ? '<span class="badge badge-prime">‚ú¶ PRIME</span>' : ''}
          ${deal.category ? `<span class="badge badge-cat">#${deal.category}</span>` : ''}
        </div>
        <div class="deal-title">${deal.title || 'Amazon Deal'}</div>
        <div class="deal-price-row">
          ${deal.price ? `<span class="deal-price">$${Number(deal.price).toFixed(2)}</span>` : ''}
          ${deal.original_price ? `<span class="deal-original">$${Number(deal.original_price).toFixed(2)}</span>` : ''}
          ${deal.discount_percent ? `<span class="deal-discount">-${deal.discount_percent}%</span>` : ''}
        </div>
        <div class="deal-meta">
          ${deal.rating ? `‚≠ê ${deal.rating}` : ''}
          ${deal.review_count ? `(${Number(deal.review_count).toLocaleString()})` : ''}
          ${deal.ai_score != null ? `<span class="ai-chip">ü§ñ ${Number(deal.ai_score).toFixed(1)}</span>` : ''}
        </div>
      </div>
    </a>`;
  }).join('');
}

async function doSearch() {
  const q = document.getElementById('searchInput').value.trim();
  if (!q) return;

  showPage('searchPage');
  setNav('navSearch');
  document.getElementById('searchTitle').textContent = `üîç "${q}"`;
  document.getElementById('searchGrid').innerHTML = `
    <div class="skel-card skeleton"></div>
    <div class="skel-card skeleton"></div>
    <div class="skel-card skeleton"></div>
  `;

  // First search locally in allDeals
  const local = allDeals.filter(d =>
    d.title && d.title.toLowerCase().includes(q.toLowerCase())
  );

  if (local.length) {
    renderDeals(local, 'searchGrid');
    return;
  }

  // Then search via backend
  try {
    const res = await fetch(`${BACKEND}/search?q=${encodeURIComponent(q)}&limit=10`);
    const data = await res.json();
    renderDeals(data.deals || [], 'searchGrid');
  } catch(e) {
    document.getElementById('searchGrid').innerHTML =
      `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><h3>Connection Error</h3></div>`;
  }
}

document.getElementById('searchInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') doSearch();
});

function focusSearch() {
  document.getElementById('searchInput').focus();
  setNav('navSearch');
}

function goHome() {
  showPage('homePage');
  setNav('navHome');
}

function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0, 0);
}

function setNav(id) {
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(id)?.classList.add('active');
}

init();
</script>
</body>
</html>
